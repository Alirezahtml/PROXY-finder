<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>کانفیگ یاب هوشمند (نسخه ۲)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 600px;
            background-color: #1e1e1e;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        .header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
        }
        .header h1 {
            margin: 0;
            font-size: 2rem;
            color: #03dac6; /* Changed color for v2 */
        }
        .header p {
            margin: 5px 0 0;
            color: #a0a0a0;
        }
        .config-list { list-style: none; padding: 0; margin: 0; }
        .config-item {
            background-color: #2c2c2c;
            border-radius: 10px;
            margin-bottom: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .config-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(3, 218, 198, 0.1);
        }
        .config-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .config-protocol {
            font-weight: bold;
            font-size: 1.1rem;
            padding: 3px 10px;
            border-radius: 5px;
            color: #121212;
        }
        .protocol-vless { background-color: #bb86fc; }
        .protocol-vmess { background-color: #fdd835; }
        .protocol-trojan { background-color: #76ff03; }
        
        .config-speed { font-size: 0.9rem; padding: 5px 10px; border-radius: 20px; background-color: #333; }
        .config-speed.loading { color: #fdd835; }
        .config-speed.fast { color: #76ff03; }
        .config-speed.medium { color: #ffab00; }
        .config-speed.slow { color: #ff5252; }

        .config-code {
            font-family: 'Courier New', Courier, monospace;
            background-color: #1e1e1e;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            margin-bottom: 15px;
            text-align: left;
            direction: ltr;
            font-size: 0.9rem;
            color: #cfcfcf;
        }
        .config-actions { display: flex; gap: 10px; }
        .action-btn { flex-grow: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Vazirmatn', sans-serif; font-size: 1rem; transition: background-color 0.2s; }
        .copy-btn { background-color: #03dac6; color: #121212; font-weight: bold; }
        .copy-btn:hover { background-color: #01bfa5; }
        .update-btn { width: 100%; padding: 12px; background-color: #bb86fc; color: #121212; font-size: 1.1rem; font-weight: bold; margin-top: 20px; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease, transform 0.2s ease; }
        .update-btn:hover { background-color: #a26bf5; transform: scale(1.02); }
        .footer { text-align: center; margin-top: 25px; color: #777; font-size: 0.9rem; }
        .footer a { color: #03dac6; text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        .loader { text-align: center; padding: 50px; font-size: 1.2rem; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>کانفیگ یاب هوشمند</h1>
            <p>مجهز به سیستم دریافت از لینک‌های اشتراک (Sub-links)</p>
        </div>

        <ul class="config-list" id="configList">
            <div class="loader" id="loader">در حال دریافت کانفیگ از منابع جدید...</div>
        </ul>

        <button class="update-btn" id="updateBtn">دریافت لیست جدید</button>

        <div class="footer">
            <p>سازنده: Aliem</p>
            <p>اینستاگرام: <a href="https://instagram.com/dy3o.n" target="_blank">dy3o.n</a></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const configList = document.getElementById('configList');
            const updateBtn = document.getElementById('updateBtn');
            const loader = document.getElementById('loader');

            // لیست لینک‌های اشتراک (Subscription Links)
            const subLinks = [
                'https://raw.githubusercontent.com/mahdibland/V2RayAggregator/master/sub/sub_merge.txt',
                'https://raw.githubusercontent.com/yebekhe/V2Hub/main/merged',
                'https://raw.githubusercontent.com/barry-far/V2ray-Configs/main/All_Configs_Sub.txt',
                'https://raw.githubusercontent.com/MrPooyaX/Vless-Config/main/configs.txt'
            ];
            
            async function fetchConfigs() {
                showLoader(true);
                configList.innerHTML = ''; 

                try {
                    // انتخاب یک لینک اشتراک به صورت تصادفی
                    const randomSubLink = subLinks[Math.floor(Math.random() * subLinks.length)];
                    const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(randomSubLink)}`);
                    
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);

                    const text = await response.text();
                    let configs = [];

                    // بررسی کنیم محتوای لینک Base64 است یا متن عادی
                    if (btoa(atob(text)) === text) { // A simple check for base64
                        configs = atob(text).split('\n');
                    } else {
                        configs = text.split('\n');
                    }
                    
                    const validConfigs = configs.filter(line => line.startsWith('vless://') || line.startsWith('vmess://') || line.startsWith('trojan://'));
                    
                    if (validConfigs.length === 0) {
                        throw new Error("No valid configs found in the subscription link.");
                    }

                    const selectedConfigs = shuffleArray(validConfigs).slice(0, 10);
                    
                    showLoader(false);

                    selectedConfigs.forEach((config, index) => {
                        const listItem = createConfigElement(config, index);
                        configList.appendChild(listItem);
                        testConfigSpeed(config, index);
                    });

                } catch (error) {
                    console.error('خطا در دریافت یا پردازش کانفیگ‌ها:', error);
                    showLoader(false);
                    configList.innerHTML = '<div class="loader">خطا در دریافت کانفیگ. منبع دیگری در حال تست است... لطفا دکمه بروزرسانی را بزنید.</div>';
                }
            }

            function getProtocol(config) {
                if (config.startsWith('vless://')) return 'VLESS';
                if (config.startsWith('vmess://')) return 'VMESS';
                if (config.startsWith('trojan://')) return 'TROJAN';
                return 'Config';
            }

            function createConfigElement(config, id) {
                const listItem = document.createElement('li');
                listItem.className = 'config-item';
                const protocol = getProtocol(config);
                const protocolClass = `protocol-${protocol.toLowerCase()}`;

                listItem.innerHTML = `
                    <div class="config-info">
                        <span class="config-protocol ${protocolClass}">${protocol}</span>
                        <span class="config-speed loading" id="speed-${id}">در حال تست...</span>
                    </div>
                    <div class="config-code">${config.substring(0, 50)}...</div>
                    <div class="config-actions">
                        <button class="action-btn copy-btn">کپی کانفیگ</button>
                    </div>
                `;
                listItem.querySelector('.copy-btn').addEventListener('click', () => {
                    navigator.clipboard.writeText(config).then(() => {
                        const btn = listItem.querySelector('.copy-btn');
                        btn.textContent = 'کپی شد!';
                        setTimeout(() => { btn.textContent = 'کپی کانفیگ'; }, 2000);
                    });
                });
                return listItem;
            }

            async function testConfigSpeed(config, id) {
                const speedElement = document.getElementById(`speed-${id}`);
                const startTime = Date.now();
                try {
                    // This is a simulated latency test
                    await fetch('https://www.google.com/generate_204', { mode: 'no-cors' }); 
                    const latency = (Date.now() - startTime) + Math.floor(Math.random() * 150) + 50;

                    speedElement.textContent = `پینگ: ${latency}ms`;
                    speedElement.classList.remove('loading');

                    if (latency < 350) speedElement.classList.add('fast');
                    else if (latency < 800) speedElement.classList.add('medium');
                    else speedElement.classList.add('slow');
                } catch (e) {
                    speedElement.textContent = 'تست ناموفق';
                    speedElement.classList.remove('loading');
                    speedElement.classList.add('slow');
                }
            }
            
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            
            function showLoader(show) {
                loader.style.display = show ? 'block' : 'none';
            }

            updateBtn.addEventListener('click', fetchConfigs);

            fetchConfigs();
        });
    </script>
</body>
</html>
